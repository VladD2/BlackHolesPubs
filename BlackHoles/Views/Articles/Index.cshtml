@using BlackHoles.Models;
@using BlackHoles.Utils;
@model IEnumerable<Article>

@{
  var title = "Публикуемые статьи";
  ViewBag.Title = title;
}

<div style="max-width: 1200px; margin: auto;">
  <h2>@title</h2>

  @if (User.IsInRole(Constants.EditorRole))
  {
    var articles = Model.ToList();
    var groupedByIssue = articles.GroupBy(a => a.Issue);
    <div>
      <dl class="dl-horizontal">
        <dt>Принятых статей:</dt>
        <dd>
          @{ var strs = groupedByIssue.Select(g => new { Issue = g.Key, Count = g.Count(a => a.Status == ArticleStatus.Accepted) }).Where(g => g.Count > 0)
              .Select(g => $@"{g.Issue.Year} {g.Issue.Number}: {g.Count}"); }
          @string.Join(", ", strs)
        </dd>

        <dt>Требует проверки:</dt>
        <dd>@articles.Count(a => a.Status == ArticleStatus.RequiresVerification)</dd>

        <dt>Проверен&nbsp;Antiplagiat:</dt>
        <dd>@articles.Count(a => a.Status == ArticleStatus.AddedToAntiplagiat)</dd>

        <dt>Загружен&nbsp;отчет&nbsp;Antiplagiat:</dt>
        <dd>@articles.Count(a => a.Status == ArticleStatus.AntiplagiatReportLoaded)</dd>

        <dt>С ошибками:</dt>
        <dd>@articles.Count(a => a.Status == ArticleStatus.HasErrors)</dd>

        <dt>Всего статей:</dt>
        <dd>@articles.Count(a => a.Status != ArticleStatus.Published && a.Status != ArticleStatus.PublishedButNotPaid)</dd>
      </dl>
    </div>
  }

  <p>
    @Html.ActionLink("Доабавить статью", "Create", null, new { @class = "btn btn-primary" })
  </p>
  <table class="table table-hover">
    <tr>
      <th>@Html.DisplayNameFor(model => model.Id)</th>
      <th>@Html.DisplayNameFor(model => model.Status)</th>
      <th>@Html.DisplayName("№")</th>
      <th>@Html.DisplayNameFor(model => model.Authors)</th>
      <th>@Html.DisplayNameFor(model => model.ShortArtTitles)</th>
      <th>@Html.DisplayNameFor(model => model.Created)</th>
      <th>@Html.DisplayNameFor(model => model.Modified)</th>
      <th>@Html.DisplayNameFor(model => model.ArticleDate)</th>
      <th>@Html.Label("Файлы")</th>
      @if (User.IsInRole(Constants.EditorRole))
      {
        <th>Зарегистрировал</th>
      }
      <th></th>
    </tr>

    @foreach (var article in Model)
    {
      var trClass = "";
      switch (article.Status)
      {
        case ArticleStatus.HasErrors: trClass = "danger"; break;
        case ArticleStatus.Accepted:  trClass = "success"; break;
        case ArticleStatus.Paid:      trClass = "success"; break;
      }
      <tr class="@trClass">
        <td>@Html.DisplayFor(modelItem => article.Id)</td>
        <td><span class="@article.Status">@Html.DisplayFor(modelItem => article.Status)</span></td>
        <td>@Html.DisplayFor(m => article.IssueYear) @Html.DisplayFor(m => article.IssueNumber)</td>
        <td>@article.GetAuthorsBriefFios()</td>
        <td>@Html.DisplayFor(m => article.ShortArtTitles)</td>
        <td>@Html.DisplayFor(m => article.Created)</td>
        <td>@Html.DisplayFor(m => article.Modified)</td>
        <td>@Html.DisplayFor(m => article.ArticleDate)</td>
        <td>
          @Html.CheckBox("ArticleVersions", article.ArticleVersions > 0, new { Title = $"Загружено версий статьи:  {article.ArticleVersions}", @readonly = "readonly", disabled = "disabled" })
          @Html.CheckBox("ReviewTextVersions", article.ReviewTextVersions > 0, new { Title = $"Загружено текстовых версий рецензий или отзывов ученого совета: {article.ReviewTextVersions}", @readonly = "readonly", disabled = "disabled" })
          @Html.CheckBox("ReviewImgVersions", article.ReviewImgVersions > 0, new { Title = $"Загружено фото-версий рецензий или отзывов ученого совета: {article.ReviewImgVersions}", @readonly = "readonly", disabled = "disabled" })
        </td>
        @if (User.IsInRole(Constants.EditorRole))
        {
          <td>@Html.DisplayFor(modelItem => article.Owner.UserName) (@Html.DisplayFor(modelItem => article.Owner.Email))</td>
        }
        @Shared.TableRowButtons(new { id = article.Id })
      </tr>
    }
  </table>
</div>